SELECT   ordernumber.number AS 订单编号, ordernumber.[红瓶(个)] AS 红瓶, ISNULL(cxx.rbred, 0) AS 红星R, ISNULL(cxx.rbgreen, 
                0) AS 绿星R, ISNULL(cxx.rbblue, 0) AS 蓝星R, ordernumber.[绿瓶(个)] AS 绿瓶, ISNULL(cxx.gbred, 0) AS 红星G, 
                ISNULL(cxx.gbgreen, 0) AS 绿星G, ISNULL(cxx.gbblue, 0) AS 蓝星G, ordernumber.[蓝瓶(个)] AS 蓝瓶, ISNULL(cxx.bbred, 
                0) AS 红星B, ISNULL(cxx.bbgreen, 0) AS 绿星B, ISNULL(cxx.bbblue, 0) AS 蓝星B, ordernumber.scheduling AS 排产时间, 
                ordernumber.status AS 订单状态
FROM      (SELECT   app_order_1.number, e.[红瓶(个)], e.[绿瓶(个)], e.[蓝瓶(个)], e.[key], e.scheduling, e.status
                 FROM      (SELECT   [key], MAX(CASE color WHEN '红瓶' THEN cbcount ELSE 0 END) AS [红瓶(个)], 
                                                  MAX(CASE color WHEN '绿瓶' THEN cbcount ELSE 0 END) AS [绿瓶(个)], 
                                                  MAX(CASE color WHEN '蓝瓶' THEN cbcount ELSE 0 END) AS [蓝瓶(个)], scheduling,
                                                      (SELECT   name
                                                       FROM      dbo.app_orderstatus
                                                       WHERE   ([key] = t.status_id)) AS status
                                  FROM      (SELECT   dbo.app_bottle.color, COUNT(dbo.app_bottle.color) AS cbcount, dbo.app_order.[key], 
                                                                   dbo.app_order.scheduling, dbo.app_order.status_id
                                                   FROM      dbo.app_bottle INNER JOIN
                                                                   dbo.app_order ON dbo.app_bottle.order_id = dbo.app_order.[key]
                                                   GROUP BY dbo.app_bottle.color, dbo.app_order.[key], dbo.app_order.scheduling, 
                                                                   dbo.app_order.status_id) AS t
                                  GROUP BY [key], scheduling, status_id) AS e LEFT OUTER JOIN
                                 dbo.app_order AS app_order_1 ON e.[key] = app_order_1.[key]) AS ordernumber LEFT OUTER JOIN
                    (SELECT   ISNULL(rgb.rborderid, bb.order_id) AS rgborderid, rgb.rbcolor, rgb.rbred, rgb.rbgreen, rgb.rbblue, 
                                     rgb.gbcolor, rgb.gbred, rgb.gbgreen, rgb.gbblue, bb.color AS bbcolor, bb.red AS bbred, bb.green AS bbgreen, 
                                     bb.blue AS bbblue
                     FROM      (SELECT   ISNULL(rb.order_id, gb.order_id) AS rborderid, rb.color AS rbcolor, rb.red AS rbred, 
                                                      rb.green AS rbgreen, rb.blue AS rbblue, ISNULL(gb.order_id, rb.order_id) AS gborder_id, 
                                                      gb.color AS gbcolor, gb.red AS gbred, gb.green AS gbgreen, gb.blue AS gbblue
                                      FROM      (SELECT   order_id, color, red, green, blue
                                                       FROM      dbo.app_bottle AS app_bottle_3
                                                       WHERE   (color = '红瓶')
                                                       GROUP BY color, red, green, blue, order_id) AS rb FULL OUTER JOIN
                                                          (SELECT   order_id, color, red, green, blue
                                                           FROM      dbo.app_bottle AS app_bottle_2
                                                           WHERE   (color = '绿瓶')
                                                           GROUP BY color, red, green, blue, order_id) AS gb ON rb.order_id = gb.order_id) 
                                     AS rgb FULL OUTER JOIN
                                         (SELECT   order_id, color, red, green, blue
                                          FROM      dbo.app_bottle AS app_bottle_1
                                          WHERE   (color = '蓝瓶')
                                          GROUP BY color, red, green, blue, order_id) AS bb ON rgb.rborderid = bb.order_id) AS cxx ON 
                ordernumber.[key] = cxx.rgborderid